

# Proof of audit workflow

The basic POA workflow contains several steps:
- SDC needs to sign a transaction then tries to execute SIGN_INVOICE command.
- SAM card returns a byte array containing signature. If no more signatures are allowed and audit procedure is needed a SW_MAX_UNAUDITED_TRANSACTIONS response will be thrown.
- At this point SDC has to start POA sending a START_AUDIT command.
- Once the SAM receives the command, and after making some initial checks, it starts building an object (auditData). This piece of information is returned to the card, although not directly. For privacy and integrity reasons it is encrypted and signed. auditData is composed by the following elements:
  1. The SerialID of the certificate present in the card.
  2. TRANSACTIONS_COUNTER.
  3. LAST_AUDITED_TRANSACTION_COUNTER.
  4. The COUNTERS object.
  5. A random token of 32 Bytes.
- ATAX API contains an endpoint to receive auditData. SDC is responsible to send the request. Server behaviour is explained in the next sections.
- ATAX API answers a HTTP code with status and a JSON payload containing information about the flow.
- At this point If the POA is complete SDC will be able to send VERIFY_AUDIT command to SAM card
- If POA is not complete SDC must wait. There’s an GET ATAX API endpoint (/poa) to get the status. This additional steps are explained later.
- If the VERIFY_AUDIT is complete SAM responses SUCCESS. Otherwise and error is thrown.

## Enpoints
### Create Proof of audit

`https://HOST/poa`

Endoint | Method | Content | Description
------------ | ------------- | ------------ | -------------
poa | POST | byte[] | Contains the SAM card START_AUDIT response

### Responses

**HTTP/1.1 202 Accepted**

The request has been accepted for processing, but there isn't any pending Proof Of Audit to process.

**HTTP/1.1 400 Bad Request**

Exception found

**HTTP/1.1 200 OK**

Field | Type | Description
cancel | boolean | TRUE if POA is cancelled
complete | boolean | TRUE is POA is completed
mrc | string | device assigne to POA
token | string | decrypted token generated by SAM during startAudit
signature | string | Base64 containing token signed by ATAX private key

**Pending POA**
Server is waiting until all transactions arrived
```
{
 "cancel":false,
 "complete":false,
 "mrc":"test",
 "token":"rV0VqGO6UPDBkVVCSX1rkffaC9pqZJqh2POFIpvyTX4="
}
```

**Completed POA**
```
{
    "cancel":false,
    "complete":true,
    "mrc":"test",
    “token":"rV0VqGO6UPDBkVVCSX1rkffaC9pqZJqh2POFIpvyTX4=",
    "signature": "O6UPDBk..."
}
```
